# SP_Ultra_CAP

### 目录内容

此文件夹用以存放工程说明文件；

**drawio源文件**存放所有框图的源文件，方便大家在原框图的基础上直接修改，绘制软件使用drawio；

**STMG474相关数据手册**存放了STM32G474开发相关的官方数据手册，请各位切记数据手册才是开发的基石，当某些外设出现奇怪的毛病的时候请务必通读对应的数据手册内容。

例如HRTIM中如果比较寄存器的值小于某一个主频的阈值将会直接跳过此次PWM生成的特性困扰了笔者调试很久，此外还有一些需要注意的小问题后续更新。

### 文件简介

**数据通路.drawio.html**	对应文档的高清矢量图

**HRPWM master timer快速中断流程图.drawio.html**	对应文档的高清矢量图

**TIM2_5mS中断流程图.drawio.html**	对应文档的高清矢量图

**代码控制框图.drawio.html**	对应文档的高清矢量图

**设计电源拓扑.drawio.html**	对应文档的高清矢量图

**超级电容控制板技术报告.pdf	设计报告矢量图**

### 文件使用环境

PC

碳基生命

### 文件使用方法

用视觉传感器将数据捕捉之后存储进记忆体中，之后将数据通过总线发送给处理器进行数据解析

### 技术报告部分内容预览

​		超级电容控制板的设计始于2022年的10月：彼时，山海Mas站队刚刚建队不久，正处于危急存亡之秋XD，并且笔者本人在此之前从来没接触过数字电源设计（笔者本职是搞FPGA的），再加上整个战队能做硬件设计比较好的成员就我一个，于是扛下了车车中所有硬件电路的设计和走线的规划。从0开始的学习是艰难的，我们战队刚成立不久，没有技术积累，笔者又没有对应的经验，只能靠自己一步一步的摸索，更别说从建队到联盟赛只有短短几个月的时间。

​		主要的设计是在大三的寒假期间内完成的，那段时间除了吃饭睡觉就是看资料，狠狠的加大班，终于在开学之前完成了原理图PCB设计以及代码框架的初步建立。开学之后休息了一段时间又是猛猛加班完成了代码。

​		原理图与PCB的绘制顺风顺水，主要是在代码开发的过程中状况频出：HRPWM有一个比较器值直接给0x0000跳过此次PWM生成的特性，而且这个特性还只有HRTIM_CHA以及HRTIM_CHB的第一个和第三个比较器上有，正好我就是用的这两个比较器用以调整输出占空比，结果一直碰上短路触发保护代码的情况，困扰了我很长时间。最后还是在去天津滨海新区看海散心的时候在火车上看数据手册的时候发现了这个问题；只能说是功夫不负有心人了，数据手册原描述如下：



​		最小值必须大于或等于fHRTIM时钟的3个周期。值0x0000只能写入CMP1和CMP3寄存器，以跳过PWM脉冲。后来调整了代码解决了这个问题

​		另外一个情况是输入电流检测的问题，输入电流因为DCDC一直工作的原因，采样到的电流本身就应该是一个跟随开关情况的方波状态，需要对这个方波进行滤波才能得到一个比较稳定的直流值，仿真示意图如下：



​		因为当初觉得使用滤波也能达到这样的效果，再加上带PWM抑制器的电流感应放大器都比较贵，就是用了性价比比较高（垃圾）的运放，然后使用软件滤波的方案。一开始使用的是硬件低通滤波加传统乘以  的软件低通滤波器，截止频率给到了100Hz才能使得输出的结果保持在一个稳定的状态。但是系统的计算频率是200kHz，100Hz的输入信号不满足采样定理，就一直导致功率环振荡，并且软件低通滤波器一多也导致系统一直卡在200kHz中断中（这是执念，就是想用控制频率200kHz）。后来发现了FMAC外设就将输入的电流滤波使用FMAC外设完成了。

​		说起FMAC外设，这里需要特别感谢一下智能车实验室的谷逸明同学。因为G474资料很少，我们配置DMA使用FMAC外设花了整整一天加一个通宵的时间（我们两个智障搞错了一个很简单的概念导致一直卡在一个地方）。最后使用了一阶IIR滤波，输入电流的采样频率为了满足滤波导致的频率开销，选择了400kHz的采样，最后滤波效果很好，可以看到测试视频里头的功率环十分稳定，响应也很快。

​		另外特别感谢一下深圳科技大学的熊泽华，这位老哥在技术上与我有不少的交流，也提供了一些很好的思路。笔者迄今为止也做过不少竞赛了，但还是被Robomaster竞赛开放的生态所吸引，在这里的大家从不吝啬自己的技术，总是大大方方的拿出来给别人看，这也是驱动笔者在紧张的考研复习期间完成这份开源报告的源动力。我也想为Robomaster的开源生态献出自己的一份绵薄之力。

​		最后需要感谢一下在山海Mas战队的大家，战队建队的第一年尤其不易，在没有先人的基础上，每位队员身上都肩负着很多责任。尤其需要感谢我们的队长，在建队初期时我一度以为我们没有办法真正的迈向赛场，到现在我们第一年参加联盟赛就获得了山东站十六强、辽宁站十六强的成绩，我对我们队长的领导和沟通能力表示深深的折服。另外也感谢同样身负重任的其它技术骨干，在我大学生涯的Last Dance能这么尽兴也多亏了大家。
